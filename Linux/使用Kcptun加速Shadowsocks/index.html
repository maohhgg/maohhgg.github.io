<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 使用Kcptun加速Shadowsocks · maohhgg</title><meta name="description" content="使用Kcptun加速Shadowsocks - maohhgg"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://maohhgg.github.io/atom.xml" title="maohhgg"><meta name="generator" content="Hexo 4.0.0"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/tags/" target="_self" class="nav-list-link">TAG</a></li><li class="nav-list-item"><a href="https://github.com/maohhgg" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">使用Kcptun加速Shadowsocks</h1><div class="post-tags"><a href="/tags/Linux/">#Linux</a><a href="/tags/%E7%BF%BB%E5%A2%99/">#翻墙</a></div><div class="post-info">2017年3月7日</div><div class="post-content"><p>最近终于忍受不了访问Google速度慢，搜索东西时url改变了，但还是停在Google首页！！！！，还有atom插件老奔溃，插件一奔溃就检查是否有更新。然而一更新半年都没反应。</p>
<p>偶然间读到一篇关于Google BBR拥塞算法，他是一个TCP加速优化工具，用于优化 TCP 连接，听说最近挺火的。有不少人用来优化Shadowsocks的TCP连接，翻墙的速度翻了倍。<code>（聪明的你发现了这个标题不符啊，这个下面来详述。）</code>这使我燃起了购买海外VPS的欲望，遂买了搬瓦工<a href="https://bandwagonhost.com/" target="_blank" rel="noopener">https://bandwagonhost.com/</a>一年的VPS<code>（他家支持支付宝，运气好的话还可以买到3.99$/year。）</code>。</p>
<a id="more"></a>
<h3 id="Shadowsocks"><a href="#Shadowsocks" class="headerlink" title="Shadowsocks"></a>Shadowsocks</h3><p>在安装好系统后，<code>（我这安装的是Ubuntu16.04，搬瓦工默认是centOS6）</code> 搬瓦工贴心的给你设置了不好记的密码，常用服务端口号也改成了不常用的了，所以我修改Root密码，更改了SSH端口号，方便自己。</p>
<h4 id="创建Shadowsocks服务"><a href="#创建Shadowsocks服务" class="headerlink" title="创建Shadowsocks服务"></a>创建Shadowsocks服务</h4><p>Shadowsocks服务端有不同的语言版本的，Shadowsocks服务端主流有：</p>
<ul>
<li>shadowsocks-nodejs</li>
<li>shadowsocks-libev</li>
<li>shadowsocks-python</li>
<li>shadowsocks-go</li>
</ul>
<p>我选择了python版的，因为刚刚安装的系统，python没有包管理pip，先要安装pip</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;bootstrap.pypa.io&#x2F;get-pip.py</span></pre></td></tr><tr><td class="code"><pre><span class="line">python get-pip.py</span></pre></td></tr></table></figure>
<p>安装Shadowsocks</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip install shadowsocks</span></pre></td></tr></table></figure>
<p>然后创建一个shadowsocks配置文件。个人习惯使用nano而不是vi或vim，vi的操作繁琐，在加上ssh连接有延迟，修改文本很难操作。一般nano不是默认都有的，所以先安装上。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">apt-get isntall nano</span></pre></td></tr><tr><td class="code"><pre><span class="line">touch &#x2F;etc&#x2F;shadowsocks.json</span></pre></td></tr><tr><td class="code"><pre><span class="line">nano &#x2F;etc&#x2F;shadowsocks.json</span></pre></td></tr></table></figure>
<p>根据自己的服务器输入如下内容：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">"server"</span> : <span class="string">"server_ip"</span>,</span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">"server_port"</span> : <span class="string">"8388"</span>,</span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">"password"</span> : <span class="string">"password"</span>,</span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">"method"</span>:<span class="string">"aes-256-cfb"</span>,</span></pre></td></tr><tr><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<p>配置文件中个字段的含义：</p>
<ul>
<li>server: 服务器ip地址</li>
<li>server_port: 绑定shadowsocks端口，注意不要设置已经使用了的端口</li>
<li>possword: 设置shadowsocks连接密码</li>
<li>method: 加密方式</li>
</ul>
<p>如果有多个账号来使用Shadowsocks服务，该这样来配置</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">"server"</span> : <span class="string">"server_ip"</span>,</span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">"port_password"</span> : &#123;</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="attr">"8388"</span> : <span class="string">"password1"</span>,</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="attr">"8389"</span> : <span class="string">"password2"</span>,</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="attr">"8390"</span> : <span class="string">"password3"</span>,</span></pre></td></tr><tr><td class="code"><pre><span class="line">    &#125;,</span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">"method"</span>:<span class="string">"aes-256-cfb"</span>,</span></pre></td></tr><tr><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<p>每个端口有一个密码，配置项由<code>password</code>改为<code>port_password</code>。<br><strong>注意，当开启使用多用户时，<code>server</code>项的值必须为<code>0.0.0.0</code>，否则不能启动多个端口</strong></p>
<h4 id="启动或关闭Shadowsocks服务"><a href="#启动或关闭Shadowsocks服务" class="headerlink" title="启动或关闭Shadowsocks服务"></a>启动或关闭Shadowsocks服务</h4><p>启动</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ssserver -c &#x2F;etc&#x2F;shadowsocks.json -d start</span></pre></td></tr></table></figure>
<p>关闭为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ssserver -c &#x2F;etc&#x2F;shadowsocks.json -d stop</span></pre></td></tr></table></figure>
<p>Shadowsocks服务我想开机自动启动。所以把启动的命令加入了开机启动中。编辑<code>/etc/rc.local</code>，将<code>ssserver -c /etc/shadowsocks.json -d start</code>添加到<code>exit 0;</code>之前就可以了。</p>
<h4 id="Shadowsocks提速"><a href="#Shadowsocks提速" class="headerlink" title="Shadowsocks提速"></a>Shadowsocks提速</h4><p>配置好Shadowsocks后，测试成功了，该使用BBR来为Shadowsocks提速了，BBR是Google的一个开源项目，在Google的github官方项目下。github地址<a href="https://github.com/google/bbr" target="_blank" rel="noopener">https://github.com/google/bbr</a>。<br>但是注意了在项目的README文件中有 “This is not an official Google product.” 。这就搞不懂，你自己放自己官方项目下，但又写上这么一句😂。</p>
<p>BBR在2016年9月20号加入到Linux内核中去了，所以只要是去年9月以后更新Linux内核，都自带了BBR。查看自己的内核版本</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root@localhost:~# uname -r</span></pre></td></tr><tr><td class="code"><pre><span class="line">2.6.32-042stab116.2</span></pre></td></tr></table></figure>
<p>我的搬瓦工上的Ubuntu16.04内核为2.6.32，去年10月更新的Linux内核版本为4.9rc1。所以超过这个就可以了。现在2017年<br>3月最新的Linux内核稳定版为4.10.1。<br>下载安装最新的内核，我的系统为64位操作系统，所以</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget http:&#x2F;&#x2F;kernel.ubuntu.com&#x2F;~kernel-ppa&#x2F;mainline&#x2F;v4.10.1&#x2F;linux-headers-4.10.1-041001_4.10.1-041001.201702260735_all.deb</span></pre></td></tr><tr><td class="code"><pre><span class="line">wget http:&#x2F;&#x2F;kernel.ubuntu.com&#x2F;~kernel-ppa&#x2F;mainline&#x2F;v4.10.1&#x2F;linux-headers-4.10.1-041001-generic_4.10.1-041001.201702260735_arm64.deb</span></pre></td></tr><tr><td class="code"><pre><span class="line">wget http:&#x2F;&#x2F;kernel.ubuntu.com&#x2F;~kernel-ppa&#x2F;mainline&#x2F;v4.10.1&#x2F;linux-image-4.10.1-041001-generic_4.10.1-041001.201702260735_arm64.deb</span></pre></td></tr><tr><td class="code"><pre><span class="line">dpkg -i *.deb</span></pre></td></tr></table></figure>
<p>安装完成以后重启就好了。</p>
<p>但是万万没想到，我的重启以后查看内核版本，发现没有丝毫的变化还是<code>2.6.32-042stab116.2</code>。但是我是安装成功了的啊。<br>使用dpkg查看我安装内核。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dpkg -l | grep &quot;linux-image&quot;</span></pre></td></tr></table></figure>
<p>也只看到了<code>linux-image-4.10.1-041001</code>,说明内核安装成功了的，但是现在正在使用的内核版本又看不见，上网Google下。</p>
<p>在Google上补课后发现，VPS分为OpenVZ、Xen和KVM，OpenVZ平台的VPS不能对Linux内核进行更新！！！ 而搬瓦工的又给了上古的Linux内核，所以BBR我是没法体验了。所以以后又同学买VPS，可以注意自己的使用环境，买合适的VPS。</p>
<p>虽然不能使用BBR，但是我在补课时发现还有其他的几种加速方式，Finalspeed、Kcptun和锐速。<br>锐速是收费的，网上有破解版，但是锐速要求内核版本最低为3.13   ×<br>Finalspeed是在搬瓦工上使用比较多，但是有反应内存占用多的情况   ×<br>所以我使用了Kcptun</p>
<h3 id="Kcptun"><a href="#Kcptun" class="headerlink" title="Kcptun"></a>Kcptun</h3><p>Kcptun 是 KCP 协议的一个简单应用，它可以将 TCP 转换为 KCP + UDP。由于 Kcptun 使用 Go 语言编写，内存占用低<br>KCP 协议一个快速可靠协议，能以 TCP 浪费10%-20%的带宽的代价，换取平均延迟降低 30%-40%，且最大延迟降低三倍的传输效果。KCP协议是我知乎唯一关注的程序猿<a href="https://www.zhihu.com/people/skywind3000/answers" target="_blank" rel="noopener">韦易笑</a>开发的 😊。<br>KCP 协议项目地址：  <a href="https://github.com/skywind3000/kcp" target="_blank" rel="noopener">https://github.com/skywind3000/kcp</a><br>Kcptun项目地址：<a href="https://github.com/xtaci/kcptun" target="_blank" rel="noopener">https://github.com/xtaci/kcptun</a></p>
<h4 id="部署Kcptun"><a href="#部署Kcptun" class="headerlink" title="部署Kcptun"></a>部署Kcptun</h4><p>Kcptun的安装部署比较简单了。因为已经有人编写了一键部署脚本，所以安装步骤 <a href="https://blog.kuoruan.com/110.html" target="_blank" rel="noopener">链接</a>，我就不重复一遍了。</p>
<p>但是在我安装的时候出错了。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Traceback (most recent call last):</span></pre></td></tr><tr><td class="code"><pre><span class="line">  File &quot;&#x2F;usr&#x2F;bin&#x2F;easy_install&quot;, line 7, in &lt;module&gt;</span></pre></td></tr><tr><td class="code"><pre><span class="line">  ****</span></pre></td></tr><tr><td class="code"><pre><span class="line">  File &quot;&#x2F;usr&#x2F;lib&#x2F;python2.7&#x2F;bin&#x2F;easy_install&quot;, line 1, in &lt;module&gt;</span></pre></td></tr><tr><td class="code"><pre><span class="line">from pkg_resources.extern import VendorImporter</span></pre></td></tr><tr><td class="code"><pre><span class="line">ImportError: No module named extern</span></pre></td></tr></table></figure>

<p>在检查后发现Python正常，extern模块是存在的。仔细阅读错误信息后发现。前后easy_install不是同一个文件。回想起来，我中途使用了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">apt-get update</span></pre></td></tr><tr><td class="code"><pre><span class="line">apt-get dist-upgrade</span></pre></td></tr></table></figure>
<p>来更新所有的包。导致了python的路径改变。手动做一个软链接后正常。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">rm &#x2F;usr&#x2F;bin&#x2F;easy_install</span></pre></td></tr><tr><td class="code"><pre><span class="line">ln -s &#x2F;usr&#x2F;lib&#x2F;python2.7&#x2F;bin&#x2F;easy_install &#x2F;usr&#x2F;bin&#x2F;easy_install</span></pre></td></tr></table></figure>

<p>最后附上一张youtube效果图 可以看到youtube连接已经到了9Mbps，所以youtube 4K画质也不是问题<br><img src="/Linux/%E4%BD%BF%E7%94%A8Kcptun%E5%8A%A0%E9%80%9FShadowsocks/youtube.png" alt="youtube"></p>
</div></article></div></main><footer><div class="paginator"><a href="/Linux/composer/" class="prev">上一篇</a><a href="/JavaScript/console/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'maohhgg';
var disqus_identifier = 'Linux/使用Kcptun加速Shadowsocks/';
var disqus_title = '使用Kcptun加速Shadowsocks';
var disqus_url = 'http://maohhgg.github.io/Linux/使用Kcptun加速Shadowsocks/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//maohhgg.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2019 <a href="http://maohhgg.github.io">maohhgg</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/maohhgg/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-110078780-1",'auto');ga('send','pageview');</script></body></html>