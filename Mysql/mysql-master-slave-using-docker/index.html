<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 使用Docker配置Mysql主从复制 · maohhgg</title><meta name="description" content="使用Docker配置Mysql主从复制 - maohhgg"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://maohhgg.github.io/atom.xml" title="maohhgg"><meta name="generator" content="Hexo 4.0.0"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/tags/" target="_self" class="nav-list-link">TAG</a></li><li class="nav-list-item"><a href="https://github.com/maohhgg" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">使用Docker配置Mysql主从复制</h1><div class="post-tags"><a href="/tags/MySQL/">#MySQL</a><a href="/tags/Docker/">#Docker</a></div><div class="post-info">2019年12月4日</div><div class="post-content"><p>随着Docker的广泛应用，原来需要多台物理机或者虚拟机才能实现的任务，现在使用Docker就可以轻松完成。本篇就简单介绍使用Docker构建MySQL的主从设置，当然Docker不仅能完成构建主从复制，复杂的主主复制也可以构建。</p>
<p>我们使用<code>docker-compose</code>来创建和管理Docker容器，这将大大减少我们的工作量。所以我们首先使用docker-compose创建两个docker容器。</p>
<a id="more"></a>

<h4 id="docker-compose-yml"><a href="#docker-compose-yml" class="headerlink" title="docker-compose.yml"></a><code>docker-compose.yml</code></h4><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3.7'</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="attr">services:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">  <span class="attr">msyqlmaster:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">container_name:</span> <span class="string">mysqlmaster</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">image:</span> <span class="string">mariadb</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">ports:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">      <span class="bullet">-</span> <span class="string">'3307:3306/tcp'</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">environment:</span> </span></pre></td></tr><tr><td class="code"><pre><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">'root'</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">volumes:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">      <span class="bullet">-</span> <span class="string">'./data/mysql-master:/var/lib/mysql'</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">      <span class="bullet">-</span> <span class="string">'./config/mysql-master:/etc/mysql/conf.d'</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="code"><pre><span class="line">  <span class="attr">mysqlslave0:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">container_name:</span> <span class="string">mysqlslave0</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">image:</span> <span class="string">mariadb</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">ports:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">      <span class="bullet">-</span> <span class="string">'3308:3306/tcp'</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">environment:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">'root'</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">volumes:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">      <span class="bullet">-</span> <span class="string">'./data/mysql-slave-0:/var/lib/mysql'</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">      <span class="bullet">-</span> <span class="string">'./config/mysql-slave-0:/etc/mysql/conf.d'</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span></pre></td></tr></table></figure>

<p>接下来我们分别创建Master和Slave的<code>my.cnf</code></p>
<h4 id="config-mysql-master-my-cnf"><a href="#config-mysql-master-my-cnf" class="headerlink" title="config/mysql-master/my.cnf"></a><code>config/mysql-master/my.cnf</code></h4><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="comment"># 服务器标识 1 ~ 4294967295</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="attr">server-id</span> = <span class="number">1</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="comment"># 启用二进制日志记录</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="attr">log-bin</span>    = mysql-bin</span></pre></td></tr></table></figure>

<h4 id="config-mysql-slave-0-my-cnf"><a href="#config-mysql-slave-0-my-cnf" class="headerlink" title="config/mysql-slave-0/my.cnf"></a><code>config/mysql-slave-0/my.cnf</code></h4><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[mysqld]</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="attr">server-id</span> = <span class="number">2</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="attr">log-bin</span>    = mysql-slave-bin</span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="attr">relay_log</span>  = edu-mysql-relay-bin</span></pre></td></tr></table></figure>



<p>对于 master 我们只需要配置<code>server-id</code>和<code>log-bin</code>，由于我们使用docker-compose一同创建了两个容器，Master和Slave处于同一局域网内，<code>server-id</code>的值必须唯一。</p>
<p>配置完成后，我们创建容器并自动启动服务。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker-compose up -d</span></pre></td></tr></table></figure>

<p>下一步我们在master数据库中创建数据同步用户，并授予用户<code>REPLICATION SLAVE</code>权限。</p>
<h4 id="Master-Server"><a href="#Master-Server" class="headerlink" title="Master Server"></a><code>Master Server</code></h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建用户 slave</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> <span class="string">'slave'</span>@<span class="string">'%'</span> <span class="keyword">identified</span> <span class="keyword">by</span> <span class="string">'root'</span>;                                                     </span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="comment">-- 授予 REPLICATION SLAVE权限</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="keyword">GRANT</span> <span class="keyword">REPLICATION</span> <span class="keyword">SLAVE</span> <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">'slave'</span>@<span class="string">'%'</span>;</span></pre></td></tr></table></figure>

<p>要将Slave配置为在正确的位置启动复制过程，需要Master的二进制日志中的当前坐标。使用 <a href="http://www.searchdoc.cn/rdbms/mysql/dev.mysql.com/doc/refman/5.7/en/show-master-status.com.coder114.cn.html" target="_blank" rel="noopener"><code>SHOW MASTER STATUS</code></a>语句来确定Master当前二进制日志文件的名称和位置：</p>
<h4 id="Master-Server-1"><a href="#Master-Server-1" class="headerlink" title="Master Server"></a><code>Master Server</code></h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql &gt; SHOW MASTER STATUS;</span></pre></td></tr><tr><td class="code"><pre><span class="line">+------------------+----------+--------------+------------------+</span></pre></td></tr><tr><td class="code"><pre><span class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |</span></pre></td></tr><tr><td class="code"><pre><span class="line">+------------------+----------+--------------+------------------+</span></pre></td></tr><tr><td class="code"><pre><span class="line">| mysql-bin.000001 | 328      |              |                  |</span></pre></td></tr><tr><td class="code"><pre><span class="line">+------------------+----------+--------------+------------------+</span></pre></td></tr></table></figure>

<p>该<code>File</code>列显示日志文件的名称，列显示文件<code>Position</code>中的位置。在这个例子中，二进制日志文件是<code>mysql-bin.000001</code>和位置是328。记录这些值。你以后需要它们，当你设置Slave。它们表示从站应该开始处理来自主站的新更新的复制坐标。</p>
<h4 id="Slave-Server"><a href="#Slave-Server" class="headerlink" title="Slave Server"></a><code>Slave Server</code></h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CHANGE</span> <span class="keyword">MASTER</span> <span class="keyword">TO</span> MASTER_HOST=<span class="string">'172.22.0.2'</span>,MASTER_USER=<span class="string">'slave'</span>, MASTER_PASSWORD=<span class="string">'root'</span>, MASTER_PORT=<span class="number">3306</span>, MASTER_LOG_FILE=<span class="string">'mysql-bin.000001'</span>, MASTER_LOG_POS=<span class="number">328</span>;</span></pre></td></tr></table></figure>

<blockquote>
<p> <strong>MASTER_HOST</strong>   容器的ip地址，可以使用<code>docker inspect mysqlmaster | grep &#39;IPAddress&#39;</code>查询ip地址</p>
</blockquote>
<p>到这里已经配置完成，只需要进行最后的测试。</p>
<h4 id="Master-Server-2"><a href="#Master-Server-2" class="headerlink" title="Master Server"></a><code>Master Server</code></h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> test_replication;</span></pre></td></tr></table></figure>

<h4 id="Slave-Server-1"><a href="#Slave-Server-1" class="headerlink" title="Slave Server"></a><code>Slave Server</code></h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">DATABASES</span>;</span></pre></td></tr></table></figure>

<p>最后一条命令产生以下输出，表明复制工作正常</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+--------------------+</span></pre></td></tr><tr><td class="code"><pre><span class="line">| Database           |</span></pre></td></tr><tr><td class="code"><pre><span class="line">+--------------------+</span></pre></td></tr><tr><td class="code"><pre><span class="line">| information_schema |</span></pre></td></tr><tr><td class="code"><pre><span class="line">| mysql              |</span></pre></td></tr><tr><td class="code"><pre><span class="line">| performance_schema |</span></pre></td></tr><tr><td class="code"><pre><span class="line">| sys                |</span></pre></td></tr><tr><td class="code"><pre><span class="line">| test_replication   |</span></pre></td></tr><tr><td class="code"><pre><span class="line">+--------------------+</span></pre></td></tr></table></figure>

</div></article></div></main><footer><div class="paginator"><a href="/React/awesome-typescript-loader-use-paths/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'maohhgg';
var disqus_identifier = 'Mysql/mysql-master-slave-using-docker/';
var disqus_title = '使用Docker配置Mysql主从复制';
var disqus_url = 'http://maohhgg.github.io/Mysql/mysql-master-slave-using-docker/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//maohhgg.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2019 <a href="http://maohhgg.github.io">maohhgg</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/maohhgg/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-110078780-1",'auto');ga('send','pageview');</script></body></html>