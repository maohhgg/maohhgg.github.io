<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> lxml xpath使用中的一些坑 · maohhgg</title><meta name="description" content="lxml xpath使用中的一些坑 - maohhgg"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://maohhgg.github.io/atom.xml" title="maohhgg"><meta name="generator" content="Hexo 4.0.0"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/tags/" target="_self" class="nav-list-link">TAG</a></li><li class="nav-list-item"><a href="https://github.com/maohhgg" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">lxml xpath使用中的一些坑</h1><div class="post-tags"><a href="/tags/python/">#python</a><a href="/tags/lxml/">#lxml</a><a href="/tags/XPath/">#XPath</a></div><div class="post-info">2017年12月15日</div><div class="post-content"><h4 id="根据-class-查找"><a href="#根据-class-查找" class="headerlink" title="根据 class 查找"></a>根据 class 查找</h4><p>如果Dom含有多个ClassName，当使用<code>@class</code>用一个ClassName查找Dom时，是没有结果的。必须使用包含全部的ClassName。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 例 &lt;div class="demo test"&gt;&lt;/div&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">etree.xpath(<span class="string">'*[@class="demo"]'</span>) <span class="comment"># None</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">etree.xpath(<span class="string">'*[@class="demo test"]'</span>) <span class="comment"># &lt;class 'lxml.etree._Element'&gt;</span></span></pre></td></tr></table></figure>
<a id="more"></a>
<p>要使用单个className查找，应使用下面的方法 </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 例 &lt;div class="demo test"&gt;&lt;/div&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">etree.xpath(<span class="string">'*[contains(@class,"demo")]'</span>) <span class="comment"># &lt;class 'lxml.etree._Element'&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="comment"># 完全匹配也可</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">etree.xpath(<span class="string">'*[contains(@class,"demo test")]'</span>) <span class="comment"># &lt;class 'lxml.etree._Element'&gt;</span></span></pre></td></tr></table></figure>

<h4 id="ElementUnicodeResult类的getparent"><a href="#ElementUnicodeResult类的getparent" class="headerlink" title="ElementUnicodeResult类的getparent()"></a>ElementUnicodeResult类的getparent()</h4><p>html数据</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"para"</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    如果可选的第三个参数</span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">code</span> <span class="attr">class</span>=<span class="string">"parameter"</span>&gt;</span>strict<span class="tag">&lt;/<span class="name">code</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    为</span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">strong</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">code</span>&gt;</span>TRUE<span class="tag">&lt;/<span class="name">code</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    ，则</span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"function"</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">strong</span>&gt;</span>array_search()<span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="tag">&lt;/<span class="name">span</span>&gt;</span> </span></pre></td></tr><tr><td class="code"><pre><span class="line">    将在</span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">code</span> <span class="attr">class</span>=<span class="string">"parameter"</span>&gt;</span>haystack<span class="tag">&lt;/<span class="name">code</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    中检查</span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">em</span> <span class="attr">class</span>=<span class="string">"emphasis"</span>&gt;</span>完全相同<span class="tag">&lt;/<span class="name">em</span>&gt;</span>的元素。这意味着同样严格比较</span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">code</span> <span class="attr">class</span>=<span class="string">"parameter"</span>&gt;</span>haystack<span class="tag">&lt;/<span class="name">code</span>&gt;</span> 里</span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">code</span> <span class="attr">class</span>=<span class="string">"parameter"</span>&gt;</span>needle<span class="tag">&lt;/<span class="name">code</span>&gt;</span> 的</span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"language.types.php"</span> <span class="attr">class</span>=<span class="string">"link"</span>&gt;</span>类型<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    ，并且对象需是同一个实例。</span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></pre></td></tr></table></figure>
<p>方法</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_code</span><span class="params">(self, node, active=False)</span>:</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    c = <span class="string">''</span></span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="keyword">if</span> isinstance(node, etree._ElementUnicodeResult):</span></pre></td></tr><tr><td class="code"><pre><span class="line">        c = str(node).replace(<span class="string">'\n'</span>, <span class="string">''</span>).replace(<span class="string">' '</span>, <span class="string">''</span>).strip()</span></pre></td></tr><tr><td class="code"><pre><span class="line">        p = node.getparent()</span></pre></td></tr><tr><td class="code"><pre><span class="line">        print(p.tag + <span class="string">' : '</span> + str(p.attrib) +<span class="string">'  | content: '</span>+ c)</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">return</span> c</span></pre></td></tr><tr><td class="code"><pre><span class="line">    <span class="keyword">if</span> isinstance(node, etree._Element):</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> node.xpath(<span class="string">'node()'</span>):</span></pre></td></tr><tr><td class="code"><pre><span class="line">            c += str(get_code(item, active))</span></pre></td></tr><tr><td class="code"><pre><span class="line">        <span class="keyword">return</span> c</span></pre></td></tr></table></figure>
<p>使用上面的方法递归读取每个节点的文本内容，xpath(‘node()’)匹配文本为<a href="http://lxml.de/api/lxml.etree._ElementUnicodeResult-class.html" target="_blank" rel="noopener">lxml.etree.ElementUnicodeResult</a>对象，节点为<a href="http://lxml.de/api/lxml.etree._Element-class.html" target="_blank" rel="noopener">lxml.etree.Element</a>对象。</p>
<p>混合排版的文本ElementUnicodeResult对象getparent()不能正确获取父节点，前面有兄弟节点时getparent()获取到的时前边的兄弟节点。比如文本<code>为</code> <code>，则</code> <code>将在</code> <code>中检查</code> 都是获取到文字前边的的节点</p>
<p>前边方法的输出</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">p : &#123;&#39;class&#39;: &#39;para&#39;&#125;  content: 如果可选的第三个参数</span></pre></td></tr><tr><td class="code"><pre><span class="line">code : &#123;&#39;class&#39;: &#39;parameter&#39;&#125;  content: strict</span></pre></td></tr><tr><td class="code"><pre><span class="line">code : &#123;&#39;class&#39;: &#39;parameter&#39;&#125;  content: 为</span></pre></td></tr><tr><td class="code"><pre><span class="line">code : &#123;&#125;  content: TRUE</span></pre></td></tr><tr><td class="code"><pre><span class="line">strong : &#123;&#125;  content: ，则</span></pre></td></tr><tr><td class="code"><pre><span class="line">strong : &#123;&#125;  content: array_search()</span></pre></td></tr><tr><td class="code"><pre><span class="line">span : &#123;&#39;class&#39;: &#39;function&#39;&#125;  content: 将在</span></pre></td></tr><tr><td class="code"><pre><span class="line">code : &#123;&#39;class&#39;: &#39;parameter&#39;&#125;  content: haystack</span></pre></td></tr><tr><td class="code"><pre><span class="line">code : &#123;&#39;class&#39;: &#39;parameter&#39;&#125;  content: 中检查</span></pre></td></tr><tr><td class="code"><pre><span class="line">em : &#123;&#39;class&#39;: &#39;emphasis&#39;&#125;  content: 完全相同</span></pre></td></tr><tr><td class="code"><pre><span class="line">em : &#123;&#39;class&#39;: &#39;emphasis&#39;&#125;  content: 的元素。这意味着同样严格比较</span></pre></td></tr><tr><td class="code"><pre><span class="line">code : &#123;&#39;class&#39;: &#39;parameter&#39;&#125;  content: haystack</span></pre></td></tr><tr><td class="code"><pre><span class="line">code : &#123;&#39;class&#39;: &#39;parameter&#39;&#125;  content: 里</span></pre></td></tr><tr><td class="code"><pre><span class="line">code : &#123;&#39;class&#39;: &#39;parameter&#39;&#125;  content: needle</span></pre></td></tr><tr><td class="code"><pre><span class="line">code : &#123;&#39;class&#39;: &#39;parameter&#39;&#125;  content: 的</span></pre></td></tr><tr><td class="code"><pre><span class="line">a : &#123;&#39;href&#39;: &#39;http:&#x2F;&#x2F;php.net&#x2F;manual&#x2F;zh&#x2F;language.types.php&#39;, &#39;class&#39;: &#39;link&#39;&#125;  content: 类型</span></pre></td></tr><tr><td class="code"><pre><span class="line">a : &#123;&#39;href&#39;: &#39;http:&#x2F;&#x2F;php.net&#x2F;manual&#x2F;zh&#x2F;language.types.php&#39;, &#39;class&#39;: &#39;link&#39;&#125;  content: ，并且对象需是同一个实例。</span></pre></td></tr></table></figure>

<p>我的目的是根据他的父节点的标签 判断文字是<strong>粗体</strong> 还是<em>斜体</em><br>期待结果应该为</p>
<figure class="highlight md"><table><tr><td class="code"><pre><span class="line">如果可选的第三个参数<span class="code">`strict`</span> 为 <span class="strong">**`TRUE`**</span>，则<span class="strong">**array_searck**</span>中检查<span class="emphasis">*完全相同*</span>的元素。这意味着同样严格比较<span class="code">`haystack`</span>里<span class="code">`needle`</span>的类型，并且对象需是同一个实例。</span></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span></pre></td></tr><tr><td class="code"><pre><span class="line">$array = <span class="keyword">array</span>( <span class="number">0</span> =&gt; <span class="string">'blue'</span> , <span class="number">1</span> =&gt; <span class="string">'red'</span> , <span class="number">2</span> =&gt; <span class="string">'green'</span> , <span class="number">3</span> =&gt; <span class="string">'red'</span> ); </span></pre></td></tr><tr><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="code"><pre><span class="line">$key = array_search ( <span class="string">'green'</span> , $array ); <span class="comment">// $key = 2; </span></span></pre></td></tr><tr><td class="code"><pre><span class="line">$key = array_search ( <span class="string">'red'</span> , $array ); <span class="comment">// $key = 1; </span></span></pre></td></tr><tr><td class="code"><pre><span class="line"><span class="meta">?&gt;</span></span></pre></td></tr></table></figure>
<p>搜索一圈没找到解决。临时解决方法传入父节点，递归每层深度的父节点是一样的</p>
<p>问题发布在<a href="https://segmentfault.com/q/1010000012449373" target="_blank" rel="noopener">segmentfault</a>，等待其他大牛来解答。实际<a href="https://github.com/maohhgg/WebCrawler/blob/master/Item/php_net.py#L91" target="_blank" rel="noopener">代码</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/Mysql/config/" class="prev">上一篇</a><a href="/Linux/ubuntu-downgrade/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'maohhgg';
var disqus_identifier = 'Python/lxml-hole/';
var disqus_title = 'lxml xpath使用中的一些坑';
var disqus_url = 'http://maohhgg.github.io/Python/lxml-hole/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//maohhgg.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2019 <a href="http://maohhgg.github.io">maohhgg</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/maohhgg/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-110078780-1",'auto');ga('send','pageview');</script></body></html>